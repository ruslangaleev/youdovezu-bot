name: Deploy to k3s

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  IMAGE_NAME: youdovezu-app
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build:production:unix
          mkdir -p ../backend/Youdovezu.Presentation/wwwroot
          cp -r build/* ../backend/Youdovezu.Presentation/wwwroot/

      - name: Setup .NET
        run: |
          mkdir -p ~/.dotnet
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --channel 8.0 --install-dir ~/.dotnet --skip-non-versioned-files
          echo "$HOME/.dotnet" >> $GITHUB_PATH

      - name: Build and deploy
        working-directory: ./backend
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_SECRET_TOKEN: ${{ secrets.TELEGRAM_SECRET_TOKEN }}
        run: |
          export PATH="$HOME/.dotnet:$PATH"
          dotnet restore Youdovezu.sln
          dotnet build Youdovezu.sln --configuration Release --no-restore
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f Youdovezu.Presentation/Dockerfile .

      - name: Deploy to k3s
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/postgres-secret.yaml
          kubectl apply -f k8s/postgres-statefulset.yaml
          kubectl wait --for=condition=ready pod -l app=postgres -n youdovezu --timeout=120s
          
          kubectl create secret generic app-secret \
            --from-literal=Telegram__BotToken="${TELEGRAM_BOT_TOKEN}" \
            --from-literal=Telegram__SecretToken="${TELEGRAM_SECRET_TOKEN}" \
            -n youdovezu --dry-run=client -o yaml | kubectl apply -f -
          
          kubectl apply -f k8s/app-pvc.yaml
          kubectl apply -f k8s/app-configmap.yaml
          kubectl apply -f k8s/app-deployment.yaml
          kubectl apply -f k8s/app-service.yaml
          
          kubectl rollout status deployment/youdovezu-app -n youdovezu --timeout=180s

