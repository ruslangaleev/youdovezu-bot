name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  IMAGE_NAME: youdovezu-app
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build:production:unix
          mkdir -p ../backend/Youdovezu.Presentation/wwwroot
          cp -r build/* ../backend/Youdovezu.Presentation/wwwroot/

      - name: Setup .NET
        run: |
          mkdir -p ~/.dotnet
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --channel 8.0 --install-dir ~/.dotnet --skip-non-versioned-files
          echo "$HOME/.dotnet" >> $GITHUB_PATH

      - name: Build and deploy
        working-directory: ./backend
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_SECRET_TOKEN: ${{ secrets.TELEGRAM_SECRET_TOKEN }}
        run: |
          export PATH="$HOME/.dotnet:$PATH"
          dotnet restore Youdovezu.sln
          dotnet build Youdovezu.sln --configuration Release --no-restore
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f Youdovezu.Presentation/Dockerfile .

      - name: Deploy with Docker Compose
        working-directory: ./backend
        run: |
          docker compose -f docker-compose.prod.yml pull || true
          docker compose -f docker-compose.prod.yml up -d --build
          docker compose -f docker-compose.prod.yml ps
