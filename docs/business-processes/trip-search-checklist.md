# Чек-лист реализации функционала поиска объявлений

Данный документ содержит список задач для реализации функционала поиска объявлений от Requester'ов на основе документации [trip-search.md](./trip-search.md).

## База данных

### 1. Справочник населенных пунктов
- [ ] Создать сущность `Settlement` (Населенный пункт)
  - [ ] Поля: Id, Name, Type (тип населенного пункта), Code (код населенного пункта), IsActive
  - [ ] Тип населенного пункта (`Type`): enum или string со значениями:
    - [ ] `City` (Город)
    - [ ] `Village` (Село)
    - [ ] `Town` (Поселок городского типа)
    - [ ] `RuralSettlement` (Деревня)
    - [ ] `UrbanSettlement` (Поселок)
  - [ ] Добавить в DbContext
  - [ ] Создать миграцию
- [ ] Создать таблицу `Settlements` в базе данных
- [ ] Заполнить справочник населенными пунктами Республики Башкортостан
  - [ ] **Подход к заполнению:**
    - Включать все города республиканского значения
    - Включать города районного значения
    - Включать крупные поселки городского типа
    - Включать села и деревни, которые упоминаются в существующих поездках пользователей
    - Динамически добавлять новые населенные пункты из поездок пользователей (если они еще не в справочнике)
  - [ ] **Список основных населенных пунктов для первоначального заполнения:**
    - **Города республиканского значения (Type: City):**
      - Уфа (столица)
      - Стерлитамак
      - Салават
      - Нефтекамск
      - Октябрьский
    - **Города районного значения (Type: City):**
      - Белорецк
      - Ишимбай
      - Туймазы
      - Кумертау
      - Мелеуз
      - Бирск
      - Учалы
      - Благовещенск
      - Дюртюли
      - Янаул
      - Давлеканово
      - Баймак
      - Белебей
    - **Поселки городского типа (Type: Town):**
      - Раевский
      - Приютово
      - Красноусольский
    - **Поселки (Type: UrbanSettlement):**
      - Чишмы
      - Агидель
      - Малояз
      - Толбазы
      - Федоровка
      - Языково
    - **Села (Type: Village):**
      - Караидель (упоминается в документации)
      - Верхнеяркеево
      - Ермекеево
      - Кушнаренково
      - Старобалтачево
      - Шаран
    - **Примечание:** Список может быть расширен на основе анализа реальных поездок пользователей. Новые населенные пункты могут добавляться автоматически при создании поездок.
  - [ ] **Структура данных для каждого населенного пункта:**
    - `Id` - уникальный идентификатор (автоинкремент)
    - `Name` - название населенного пункта (например: "Уфа", "Караидель")
    - `Type` - тип населенного пункта (City, Village, Town, RuralSettlement, UrbanSettlement)
    - `Code` - код населенного пункта (опционально, для интеграции с внешними системами)
    - `IsActive` - флаг активности (по умолчанию `true`)
    - `CreatedAt` - дата создания записи
    - `UpdatedAt` - дата последнего обновления
  - [ ] **Примеры заполнения с указанием типа:**
    - Уфа - City (Город)
    - Стерлитамак - City (Город)
    - Караидель - Village (Село)
    - Раевский - Town (Поселок городского типа)
    - Чишмы - UrbanSettlement (Поселок)
- [ ] Создать индекс по полю `IsActive` для быстрого поиска активных населенных пунктов
- [ ] Создать индекс по полю `Name` для быстрого поиска по названию
- [ ] Создать индекс по полю `Type` для фильтрации по типу населенного пункта (опционально)

### 2. Связь поездок с населенными пунктами
- [ ] Поездки уже имеют поля `FromSettlement` и `ToSettlement` (названия населенных пунктов)
- [ ] Добавить в сущность `Trip` поля для связи с населенными пунктами (опционально, если нужна нормализация):
  - [ ] `FromSettlementId` (ID населенного пункта отправления)
  - [ ] `ToSettlementId` (ID населенного пункта назначения)
- [ ] Создать навигационные свойства `FromSettlement` и `ToSettlement` (если используется нормализация)
- [ ] Добавить внешние ключи и индексы (если используется нормализация)
- [ ] Создать миграцию для добавления полей (если используется нормализация)
- [ ] Обновить существующие записи в таблице `Trips` (заполнить ID населенных пунктов на основе названий)

### 3. Предложения от Offerer'ов
- [ ] Создать сущность `TripOffer` (Предложение)
  - [ ] Поля:
    - [ ] `Id` (уникальный идентификатор)
    - [ ] `TripId` (ID объявления)
    - [ ] `OffererId` (ID Offerer'а)
    - [ ] `Price` (предложенная цена)
    - [ ] `Comment` (комментарий к предложению)
    - [ ] `Status` (статус: Pending, Accepted, Rejected)
    - [ ] `CreatedAt` (дата создания)
    - [ ] `UpdatedAt` (дата обновления)
- [ ] Добавить в DbContext
- [ ] Создать миграцию
- [ ] Создать уникальный индекс на паре `(TripId, OffererId)` для предотвращения дублирования предложений
- [ ] Добавить индексы для быстрого поиска:
  - [ ] По `TripId`
  - [ ] По `OffererId`
  - [ ] По `Status`

## Backend - API Endpoints

### 4. Справочник населенных пунктов
- [ ] Создать контроллер `SettlementsController`
- [ ] Endpoint `GET /api/webapp/settlements` - получить список всех активных населенных пунктов
  - [ ] Возвращает список населенных пунктов с количеством активных поездок для каждого
  - [ ] Проверка авторизации через `initData`
  - [ ] Проверка, что пользователь является Offerer'ом с одобренными документами
- [ ] Endpoint `GET /api/webapp/settlements/{settlementId}/trips-count` - получить количество поездок в населенном пункте
  - [ ] Опционально: для оптимизации загрузки списка населенных пунктов

### 5. Поиск объявлений по населенному пункту
- [ ] Создать контроллер `TripSearchController` или расширить существующий `TripsController`
- [ ] Endpoint `GET /api/webapp/trips/search?settlement={settlementName}` - получить список объявлений в населенном пункте
  - [ ] Фильтрация по населенному пункту отправления или назначения
  - [ ] Показывать только активные объявления (Status = Active)
  - [ ] Проверка авторизации через `initData`
  - [ ] Проверка, что пользователь является Offerer'ом с одобренными документами
  - [ ] Поддержка пагинации (опционально)
  - [ ] Поддержка сортировки (по дате создания, по населенному пункту)
- [ ] Endpoint `GET /api/webapp/trips/search?settlement={settlementName}&fromSettlement={settlement}` - фильтрация по населенному пункту отправления
- [ ] Endpoint `GET /api/webapp/trips/search?settlement={settlementName}&toSettlement={settlement}` - фильтрация по населенному пункту назначения
- [ ] Endpoint `GET /api/webapp/trips/search?settlement={settlementName}&search={query}` - поиск по ключевым словам

### 6. Детальная информация об объявлении
- [ ] Endpoint `GET /api/webapp/trips/{tripId}/details` - получить детальную информацию об объявлении
  - [ ] Возвращает полную информацию о поездке
  - [ ] Возвращает информацию о Requester'е (имя, фамилия)
  - [ ] Проверка, что объявление активно
  - [ ] Проверка авторизации через `initData`
  - [ ] Проверка, что пользователь является Offerer'ом с одобренными документами
  - [ ] Проверка, не отправлял ли уже Offerer предложение на это объявление

### 7. Отправка предложения цены
- [ ] Endpoint `POST /api/webapp/trips/{tripId}/offers` - отправить предложение цены
  - [ ] Принимает: `Price` (обязательно), `Comment` (опционально)
  - [ ] Валидация: цена должна быть положительным числом
  - [ ] Проверка, что объявление активно
  - [ ] Проверка, что Offerer еще не отправлял предложение на это объявление
  - [ ] Создание записи `TripOffer` со статусом `Pending`
  - [ ] Отправка уведомления Requester'у в Telegram бот
  - [ ] Возвращает информацию о созданном предложении
- [ ] Endpoint `GET /api/webapp/trips/{tripId}/offers/my` - проверить, отправлял ли Offerer предложение на это объявление
  - [ ] Возвращает информацию о предложении или null

### 8. История предложений Offerer'а
- [ ] Endpoint `GET /api/webapp/trips/offers/my` - получить историю предложений текущего Offerer'а
  - [ ] Возвращает список всех предложений с информацией об объявлениях
  - [ ] Фильтрация по статусу (опционально)
  - [ ] Сортировка по дате создания (новые сначала)
  - [ ] Поддержка пагинации (опционально)

## Backend - Сервисы и репозитории

### 9. Репозиторий населенных пунктов
- [ ] Создать интерфейс `ISettlementRepository`
  - [ ] `GetAllActiveAsync()` - получить все активные населенные пункты
  - [ ] `GetByIdAsync(long id)` - получить населенный пункт по ID
  - [ ] `GetSettlementsWithTripsCountAsync()` - получить населенные пункты с количеством активных поездок
  - [ ] `GetSettlementsFromTripsAsync()` - получить уникальные населенные пункты из существующих поездок (если не используется нормализация)
- [ ] Создать реализацию `SettlementRepository`
- [ ] Зарегистрировать в DI контейнере

### 10. Репозиторий предложений
- [ ] Создать интерфейс `ITripOfferRepository`
  - [ ] `CreateAsync(TripOffer offer)` - создать предложение
  - [ ] `GetByTripIdAndOffererIdAsync(long tripId, long offererId)` - проверить существование предложения
  - [ ] `GetByOffererIdAsync(long offererId)` - получить все предложения Offerer'а
  - [ ] `GetByTripIdAsync(long tripId)` - получить все предложения для объявления
  - [ ] `UpdateStatusAsync(long offerId, TripOfferStatus status)` - обновить статус предложения
- [ ] Создать реализацию `TripOfferRepository`
- [ ] Зарегистрировать в DI контейнере

### 11. Сервис поиска поездок
- [ ] Создать интерфейс `ITripSearchService`
  - [ ] `GetSettlementsWithTripsCountAsync()` - получить населенные пункты с количеством поездок
  - [ ] `SearchTripsBySettlementAsync(string settlementName, string? fromSettlement, string? toSettlement, string? searchQuery)` - поиск поездок
  - [ ] `GetTripDetailsAsync(long tripId, long offererId)` - получить детальную информацию
- [ ] Создать реализацию `TripSearchService`
- [ ] Зарегистрировать в DI контейнере

### 12. Сервис предложений
- [ ] Создать интерфейс `ITripOfferService`
  - [ ] `CreateOfferAsync(long tripId, long offererId, decimal price, string? comment)` - создать предложение
  - [ ] `GetMyOffersAsync(long offererId)` - получить все предложения Offerer'а
  - [ ] `CheckIfOfferExistsAsync(long tripId, long offererId)` - проверить существование предложения
- [ ] Создать реализацию `TripOfferService`
- [ ] Интеграция с Telegram ботом для отправки уведомлений
- [ ] Зарегистрировать в DI контейнере

### 13. Обновление TripRepository
- [ ] Добавить метод `GetActiveTripsBySettlementAsync(string settlementName)` - получить активные поездки по населенному пункту
- [ ] Добавить метод `GetActiveTripsCountBySettlementAsync(string settlementName)` - получить количество активных поездок в населенном пункте
- [ ] Добавить метод `GetTripsBySettlementWithFiltersAsync(...)` - поиск с фильтрами
- [ ] Добавить индексы в базу данных для оптимизации запросов по населенным пунктам (по полям `FromSettlement` и `ToSettlement`)

## Backend - Валидация и безопасность

### 14. Проверка доступа
- [ ] Создать middleware или метод для проверки, что пользователь является Offerer'ом
- [ ] Проверка статуса документов (должен быть Approved)
- [ ] Применить проверку ко всем endpoints поиска и предложений
- [ ] Возвращать понятные ошибки при отсутствии доступа

### 15. Валидация данных
- [ ] Валидация модели `CreateTripOfferRequest`:
  - [ ] `Price` - обязательное поле, положительное число
  - [ ] `Comment` - опциональное поле, максимальная длина
- [ ] Валидация параметров поиска:
  - [ ] `settlement` - обязательный, название населенного пункта
  - [ ] `fromSettlement`, `toSettlement` - опциональные, валидация формата
  - [ ] `searchQuery` - опциональный, валидация длины

## Frontend - Компоненты и страницы

### 16. Страница выбора населенного пункта
- [ ] Создать компонент `SettlementList.tsx`
  - [ ] Отображение списка населенных пунктов
  - [ ] Отображение количества поездок для каждого населенного пункта
  - [ ] Кнопка "Назад" для возврата в главное меню
  - [ ] Состояние загрузки (спиннер)
  - [ ] Состояние пустого списка
  - [ ] Обработка ошибок
- [ ] Интеграция с API endpoint `/api/webapp/settlements`
- [ ] Добавить маршрутизацию в `App.tsx`

### 17. Страница списка объявлений в населенном пункте
- [ ] Создать компонент `TripSearchResults.tsx`
  - [ ] Отображение списка объявлений
  - [ ] Заголовок с названием населенного пункта
  - [ ] Кнопка "Назад" для возврата к выбору населенного пункта
  - [ ] Кнопка "Обновить" для обновления списка
  - [ ] Состояние загрузки (спиннер)
  - [ ] Состояние пустого списка
  - [ ] Обработка ошибок
- [ ] Отображение информации об объявлении:
  - [ ] Откуда (населенный пункт и адрес)
  - [ ] Куда (населенный пункт и адрес)
  - [ ] Дата создания
  - [ ] Комментарий (если есть)
  - [ ] Кнопка "Предложить цену"
- [ ] Интеграция с API endpoint `/api/webapp/trips/search?settlement={settlementName}`
- [ ] Добавить маршрутизацию в `App.tsx`

### 18. Страница детальной информации об объявлении
- [ ] Создать компонент `TripDetails.tsx`
  - [ ] Отображение полной информации о поездке
  - [ ] Информация о Requester'е
  - [ ] Кнопка "Показать на карте" (интеграция с Яндекс.Картами)
  - [ ] Форма для предложения цены:
    - [ ] Поле ввода цены
    - [ ] Поле ввода комментария (опционально)
    - [ ] Кнопка "Отправить предложение"
  - [ ] Валидация формы на клиенте
  - [ ] Состояние загрузки при отправке
  - [ ] Сообщение об успешной отправке
  - [ ] Обработка ошибок
- [ ] Интеграция с API endpoint `/api/webapp/trips/{tripId}/details`
- [ ] Интеграция с API endpoint `/api/webapp/trips/{tripId}/offers`
- [ ] Проверка, отправлял ли уже Offerer предложение (отключение формы или изменение кнопки)
- [ ] Добавить маршрутизацию в `App.tsx`

### 19. Страница истории предложений
- [ ] Создать компонент `MyOffers.tsx`
  - [ ] Отображение списка предложений
  - [ ] Для каждого предложения:
    - [ ] Информация об объявлении
    - [ ] Предложенная цена
    - [ ] Статус предложения
    - [ ] Дата отправки
  - [ ] Фильтрация по статусу (опционально)
  - [ ] Состояние загрузки
  - [ ] Состояние пустого списка
- [ ] Интеграция с API endpoint `/api/webapp/trips/offers/my`
- [ ] Добавить маршрутизацию в `App.tsx` (опционально, может быть в профиле)

### 20. Обновление главного меню
- [ ] Обновить логику кнопки "Предложить машину"
  - [ ] Если документы не одобрены → показывать страницу статуса документов
  - [ ] Если документы одобрены → показывать страницу выбора населенного пункта
- [ ] Добавить проверку статуса документов перед переходом

### 21. Дополнительные функции (опционально)
- [ ] Поиск по ключевым словам на странице списка объявлений
  - [ ] Поле поиска
  - [ ] Фильтрация в реальном времени
- [ ] Сортировка объявлений
  - [ ] Выпадающий список с вариантами сортировки
  - [ ] Применение сортировки к списку
- [ ] Фильтрация по населенным пунктам
  - [ ] Выпадающие списки для выбора населенных пунктов
  - [ ] Применение фильтров к списку

## Интеграция с Telegram ботом

### 22. Уведомления для Requester'а
- [ ] Создать метод в `TelegramBotService` для отправки уведомления о новом предложении
- [ ] Формат уведомления:
  - [ ] Информация об Offerer'е (имя, фамилия)
  - [ ] Предложенная цена
  - [ ] Краткая информация о маршруте
  - [ ] Кнопка "Открыть в приложении" (ссылка на веб-приложение)
- [ ] Интеграция с `TripOfferService` при создании предложения
- [ ] Обработка ошибок при отправке уведомления

### 23. Уведомления для Offerer'а (будущая функциональность)
- [ ] Уведомление о принятии предложения
- [ ] Уведомление об отклонении предложения
- [ ] Методы в `TelegramBotService` для отправки уведомлений

## Тестирование

### 24. Unit тесты (опционально)
- [ ] Тесты для `TripSearchService`
- [ ] Тесты для `TripOfferService`
- [ ] Тесты для `SettlementRepository`
- [ ] Тесты для `TripOfferRepository`

### 25. Интеграционные тесты (опционально)
- [ ] Тесты API endpoints поиска
- [ ] Тесты API endpoints предложений
- [ ] Тесты проверки доступа

### 26. Ручное тестирование
- [ ] Тестирование выбора населенного пункта
- [ ] Тестирование поиска объявлений
- [ ] Тестирование отправки предложения
- [ ] Тестирование проверки доступа (без одобренных документов)
- [ ] Тестирование уведомлений в Telegram боте
- [ ] Тестирование на разных устройствах и браузерах

## Документация

### 27. Обновление документации
- [ ] Обновить `README.md` в корне проекта с описанием новых endpoints
- [ ] Добавить примеры запросов и ответов API
- [ ] Обновить документацию по развертыванию (если необходимо)

## Оптимизация и производительность

### 28. Оптимизация запросов
- [ ] Добавить кэширование списка населенных пунктов (опционально)
- [ ] Оптимизировать запросы к базе данных (использовать индексы)
- [ ] Добавить пагинацию для больших списков (опционально)
- [ ] Оптимизировать загрузку количества поездок по населенным пунктам (batch запрос)

## Приоритеты реализации

### Высокий приоритет (MVP)
1. База данных: справочник населенных пунктов (или использование существующих полей), предложения
2. Backend: API для получения населенных пунктов, поиска поездок, детальной информации, отправки предложений
3. Frontend: страница выбора населенного пункта, список объявлений, детальная информация, форма предложения
4. Интеграция: уведомления в Telegram боте
5. Проверка доступа: только Offerer'ы с одобренными документами

### Средний приоритет
6. История предложений Offerer'а
7. Поиск по ключевым словам
8. Сортировка объявлений
9. Фильтрация по населенным пунктам

### Низкий приоритет (будущие улучшения)
10. Кэширование
11. Пагинация
12. Unit и интеграционные тесты
13. Дополнительные уведомления

